import { buildExportPubkey, buildGetIccid, buildGetVersion, buildSignMessage, buildVerifyBpin, serializeCommand } from './params';
import { ApduFlowError, exportPubkeysFlow, getIccidFlow, getVersionFlow, signMessageFlow, verifyBpinFlow } from './workflows';

const DER_SIGNATURE =
  '304402207F0F265E3F4FC52AE1A86410DA5C8BDAEB7C0B1032EB42B1E23FC326439BAFC502204A9AEE904027C3188D8F9C56F8EBAB223B7E555265F7C204E4290339F30B698B';

const PUBKEY_SEGMENT_1 = `C2470000003C020140${'EE'.repeat(32)}`;
const PUBKEY_SEGMENT_2 = 'EE'.repeat(32);

type ScriptStep = { command: string; response: string };

const createTransmit = (script: ScriptStep[]) => {
  let step = 0;
  return async (payload: string) => {
    const current = script[step];
    if (!current || current.command !== payload) {
      throw new Error(`Unexpected APDU payload: ${payload}`);
    }
    step += 1;
    return current.response;
  };
};

describe('core workflows', () => {
  it('verifies BPIN successfully', async () => {
    const transmit = createTransmit([{ command: serializeCommand(buildVerifyBpin()), response: '9000' }]);

    await expect(verifyBpinFlow(transmit)).resolves.toBeUndefined();
  });

  it('throws when BPIN verification fails', async () => {
    const transmit = createTransmit([{ command: serializeCommand(buildVerifyBpin()), response: '6A88' }]);

    await expect(verifyBpinFlow(transmit)).rejects.toBeInstanceOf(ApduFlowError);
  });

  it('signs message and returns r/s components', async () => {
    const hash = 'A1'.repeat(32);
    const transmit = createTransmit([{ command: serializeCommand(buildSignMessage(hash, 0x3c, 0x02)), response: `${DER_SIGNATURE}9000` }]);

    await expect(signMessageFlow(transmit, hash, 0x3c, 0x02)).resolves.toEqual({
      r: '7F0F265E3F4FC52AE1A86410DA5C8BDAEB7C0B1032EB42B1E23FC326439BAFC5',
      s: '4A9AEE904027C3188D8F9C56F8EBAB223B7E555265F7C204E4290339F30B698B',
    });
  });

  it('aggregates pubkey segments until success', async () => {
    const script = [
      {
        command: serializeCommand(buildExportPubkey(false)),
        response:
          'C247000001F7010104B56571DD4784DC1BBF1C288A4980E69EA33DB8ABF67BE2E0C86CB8170EE9FE71CD32415DE380BED16F236513C8A807D4EF0BE0547FE8CA27A49F489595BB3D43C2470000003C020104428BC1B51B561ADFC16A4323F6935066066BDE3FC0D05F7D59266088AA472EABC549EC5AA1F0BBB1BC15C7B364E315645B004F8DFA2A2132AB2DCFC87E535F56C2470000003C0301047E68F3F2B063AF8269490622AD0C4367BC9FDAF799F6B0C16227C7336C0CBC7A45D8FF640D4715F690DDA2092438D84A0334FDE70F491239B9A856739B8C45D6C2470000003C0401043F4694700B1513482491FD13AFA68EAA6D2C439747EC7B835494F95E6300',
      },
      {
        command: serializeCommand(buildExportPubkey(true)),
        response:
          '7645DD7198F70EF62B83887621ED58F33515CAB5FA93D61057744E02913CA006001CCB20C2470000003C050104299AC79786DA8F1D92A15F8D5D15A30C85FA47B6E04883B1C88415665E3B3CECE80B7FC3812491A2790769023B958C420715E9BE95DEA73A05FBAE3CC3D5A388C2470000003C0601043000AB2F745967985760696A2904BCEAC9D9E2CC231209EA0FC421B38BF7F79E71CC2F89540056CED4B5FBD7AB27347B00A69446E2027156F398D07030688BBEC2470000003C07010441808CE81DE56435050D249F7DCF53BB345C93209D0A0DF46E4A8EFFF2A6E1FAFF0D2A8E1669E9A38D6DEAE00DEC6EBF7ACEC918583884E6FF828552325C46D7C26300',
      },
      {
        command: serializeCommand(buildExportPubkey(true)),
        response:
          '470000003C0801043DB2E1BD8626B1B14D765048A4B766771B789E63FF6E724921831AD79309C5FB0590C9259E35C13FF1729D9EBB16DBC3C49A4ACF0771928B4474DCC84FD5B50EC2470000003C0901044FB73EDF31C26EDE2C87DBE5A58123440528E619208C0C35E819CD4350FB085A44D9DD5ED09400BA81575E4C91D0FADB8B90686A6F3381AF0BCB52B86FFCF743C2470000003C0A01043E0C9E6FFC990C42AA3A132A46A6F6F7D7CDB7E741621520B673350B96E5204A53ECE51245404DBB44F925F2492229382483AE4061B452F465FCE08ACBB8FA2AC2470000003C0B01043865564D5DA81E9180EC16F7B66430B89C3A54B96CC1760F390CDB110D6300',
      },
      {
        command: serializeCommand(buildExportPubkey(true)),
        response:
          '47A8814C7FD99FDBC73B75F7CA2183492568D15A9010C31C6560BF7F66BFCC7FB1A295C2470000003C0C0104466C5B8B359C59DFBD2AA6A3BC973532E6A201BEA2DE078C73AADFAC0AE04E21E5C1F03DB1DE2DCA0EAB6FAE6A0FCA3A0D38CBE3346823045C065C6B4A822470C2470000003C0D0104415947D941807429557E564AF119C8557650853897597036429298578BC1F040435D7C2E5BB867FF894C1B588CAD6C41AD9B3A67FB94A4B1C7E1C3F5A205F3E1C2470000003C0E01043FB823661CF6875894D88E54508F1C16C1908ECC4F42746B7ED3A641CA8B7FA1C6B8BD0ACD3DC7F5B2ABC2B139AAD3DA4D2B93EA121C5ECBE03EB9864296D77EC2476300',
      },
      {
        command: serializeCommand(buildExportPubkey(true)),
        response:
          '0000003C0F01041ED6A731B3392D627DE47A9E55CD2A3313AB38F60B7F315F3F9CC7A74F58E65C0CC20E1CB3B9AE5C8580554167EF10DB29487D47B7A0CFA42BCD076D75863E66C2470000003C10010415B8C72E576E7EDCC7D5507857390245127927E0FF8DFA49B182415320B5EF28D60ABA4AAF163B13CB9B6AA7B83A2C19618FF52C142D974EC571D3911897D53FC2470000003C1101049B61E8F045995E3A2421C5139E73BC8ED2B8FC2D22E4D69F05FBF13A623C88B23B710A4B13C438CB2FA4E9AA453260BADD489B7FB73AC7BD033707605B6594AFC2470000003C120104763FB9112BC07E15C343DFF0CAD48A50762EFF96A1B64F51CC542777770C6300',
      },
      {
        command: serializeCommand(buildExportPubkey(true)),
        response:
          '74D97424C0BA48940326CA963D21AC9B98221DE2BF8B928D052FB3DDD53DD88FC5C2C2470000003C1301042C1AA1DB354A1986489296499F9022C820D78178606CCB1B78AEE2C83934631592EB1848104C92573512756464273547E42A95A2F94566D12DB52AA6606D8EB39000',
      },
    ];

    const transmit = createTransmit(script);
    const result = await exportPubkeysFlow(transmit);

    expect(result).toHaveLength(19);
    expect(result[0]).toEqual({
      coinType: 0x01f7,
      index: 1,
      alg: 1,
      key: '04B56571DD4784DC1BBF1C288A4980E69EA33DB8ABF67BE2E0C86CB8170EE9FE71CD32415DE380BED16F236513C8A807D4EF0BE0547FE8CA27A49F489595BB3D43',
    });
    expect(result[18]).toEqual({
      coinType: 0x3c,
      index: 0x13,
      alg: 1,
      key: '042C1AA1DB354A1986489296499F9022C820D78178606CCB1B78AEE2C83934631592EB1848104C92573512756464273547E42A95A2F94566D12DB52AA6606D8EB3',
    });
  });
  it('reads version', async () => {
    const transmit = createTransmit([{ command: serializeCommand(buildGetVersion()), response: '00519000' }]);

    await expect(getVersionFlow(transmit)).resolves.toBe('0051');
  });

  it('reads ICCID', async () => {
    const iccidPayload = '89860123456789012345';
    const transmit = createTransmit([{ command: serializeCommand(buildGetIccid()), response: `${iccidPayload}9000` }]);

    await expect(getIccidFlow(transmit)).resolves.toBe(iccidPayload);
  });
});
